# Error Handling

## Design principles

Specifying hard rules on how to handle error is as much of a process as it is to design the 'happy case'-payload:

XVP is the edge of the X1 ecosystem. Clients do not and should not know which upstream services exist for XVP and when/
how these are used. 
Therefore, no details (like the involved upstream service) must be leaked to the caller.
This also applies to technical details & security relevant details: These must not be presented back to the caller (ie. no stacktraces).

While upstream services differ for various use cases, XVP should be as self-consistent as possible.

Intercepting status codes & error messages is applicable. In the end each endpoint must realize that also the error
responses are part of the interface contract (and should be documented via the respective OpenAPI annotation).
Thus passing back a response body from an upstream service is not desired: The upstream service may change its response,
effectively forcing XVP to a breaking change: XVP clients may res

Also, upstream status codes should always be analyzed and interpreted/mapped by XVP:

* Proper HTTP status codes should be sent by XVP
   * They *can* re-use numeric codes from upstream. But by doing so the XVP service now becomes responsible and effectively
     adds them to its contract itself. Future changes in the upstream service are now a breaking change in XVP itself!
     Therefore, such a reuse should only be taken where upstream is not going to change.
* The `type` fragment field is the technical identifier for a RFC7807 message and can be used to further qualify an error.
   * There is no need for an additional 'sub-status code'

### Common status codes

XVP follows the common HTTP status codes as per [RFC7231](https://tools.ietf.org/html/rfc7231).
The error codes expressed here are considered the 'generic default': A XVP service endpoint may provide
a more specific meaning for a status code which is documented in its specification document & OpenAPI annotation.

#### Success
* `200` - The request could be processed successfully, and the response can be found in the body.
* `201` - The request could be processed successfully, but there is no response body.

#### Client error
* `400` - The request could not be processed by XVP. This is a generic error code. Please check the response body for
  details. The client provided data that caused the problem.
* `401` - The request was not processed by XVP as no authentication information could be found.
* `403` - The request was not processed by XVP as the authentication information was not sufficient to access the
  resource.
* `404` - The request could be processed by XVP but there is no resource at thee designated URL (plus query parameters).

#### Server error
* `500` - The request processing in XVP caused a generic error. Please check the response body for details.
  The problem occurred independently of the actual data provided by the client.
* `503` - The XVP service could not fulfill the request. Please check the response body for details.
  The problem occurred independently of the actual data provided by the client.

## RFC7807 compliant exception handling

XVP returns client & server error messages to the client according to [RFC7807](https://tools.ietf.org/html/rfc7807).

The intent is to provide as much information in the response as possible to allow for an initial triage without
additional log analysis.

### Payload

The payload of any error message follows this JSON schema:

```json
{
  "type": "https://errors.xvp.com/ars-001",
  "title": "ARSblob not found",
  "status": 404,
  "detail":  "ARSblob not found. Provisioning needed",
  "instance": "urn:xvp:client:request#07f62cd8-4104-47e2-a42b-9d3967d08968"
}
``` 

* `type` - A URI reference that identifies the problem type. 
  This specification encourages that, when dereferenced, it provides human-readable documentation for the problem type
  but this is not implemented in XVP yet.
  The suggested format is `https://<commonPlatformDomain>/<api-surface>-<errorCode>`  
  _required: `yes`_
* `title` - A short, human-readable summary of the problem type.
  It should not change from occurrence to occurrence of the problem, so the same `type` should result in the same
  `title`.  
  _required: `yes`_
* `status` - The HTTP status code generated by the origin server. It's the same as the status code of the response itself.  
_required: `yes`_ 
* `detail` - A human-readable explanation specific to this occurrence of the problem.  
_required: `yes`_
* `instance` - A URI reference that identifies the specific occurrence of the problem.
  This should contain the `traceId` of the `Span`.
  The suggested format is `urn:xvp:client:request#$spanId`  
  _required: `yes`_
* Additional fields may be present to help identify the context of the message. Ie. an `accountId` might be
  present if an account relates to  the problem.  
  _required: `no`_

## Implementation
For implementation details please consult [error-handling-impl.md](error-handling-impl.md).
